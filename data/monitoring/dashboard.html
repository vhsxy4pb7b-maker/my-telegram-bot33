<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å®æ—¶ç›‘æ§é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
        }

        .status.connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .replies-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .replies-section h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .reply-item {
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
        }

        .reply-content {
            margin: 10px 0;
        }

        .user-message {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .ai-reply {
            background: #f1f8e9;
            padding: 10px;
            border-radius: 5px;
        }

        .platform-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }

        .platform-facebook {
            background: #1877f2;
            color: white;
        }

        .platform-instagram {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI å®æ—¶ç›‘æ§é¢æ¿</h1>
            <div>
                <span class="status" id="connectionStatus">è¿æ¥ä¸­...</span>
                <span style="margin-left: 20px;" id="lastUpdate"></span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>ä»Šæ—¥å›å¤æ•°</h3>
                <div class="value" id="todayReplies">0</div>
            </div>
            <div class="stat-card">
                <h3>ä»Šæ—¥å®¢æˆ·æ•°</h3>
                <div class="value" id="todayCustomers">0</div>
            </div>
            <div class="stat-card">
                <h3>æœ€è¿‘1å°æ—¶</h3>
                <div class="value" id="lastHour">0</div>
            </div>
            <div class="stat-card">
                <h3>åœ¨çº¿è¿æ¥</h3>
                <div class="value" id="activeConnections">1</div>
            </div>
        </div>

        <div class="replies-section">
            <h2>ğŸ“ å®æ—¶AIå›å¤è®°å½•</h2>
            <div id="repliesContainer">
                <div class="empty-state">ç­‰å¾…AIå›å¤...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let eventSource = null;
        let statsInterval = null;

        // åˆå§‹åŒ–
        function init() {
            connectSSE();
            loadInitialData();
            startStatsUpdate();
        }

        // è¿æ¥SSE
        function connectSSE() {
            eventSource = new EventSource(`${API_BASE}/monitoring/live`);

            eventSource.onopen = () => {
                document.getElementById('connectionStatus').textContent = 'âœ… å·²è¿æ¥';
                document.getElementById('connectionStatus').classList.add('connected');
            };

            eventSource.onerror = () => {
                document.getElementById('connectionStatus').textContent = 'âŒ è¿æ¥æ–­å¼€';
                document.getElementById('connectionStatus').classList.remove('connected');

                // å…³é—­æ—§è¿æ¥
                if (eventSource) {
                    eventSource.close();
                }

                // 5ç§’åé‡è¿
                setTimeout(connectSSE, 5000);
            };

            eventSource.onmessage = (event) => {
                try {
                    // è·³è¿‡å¿ƒè·³æ¶ˆæ¯
                    if (event.data.trim() === '' || event.data.startsWith(':')) {
                        return;
                    }

                    const data = JSON.parse(event.data);
                    handleEvent(data);
                } catch (e) {
                    console.error('Failed to parse event:', e);
                }
            };
        }

        // å¤„ç†äº‹ä»¶
        function handleEvent(data) {
            if (data.type === 'ai_reply') {
                // å°†timestampæ·»åŠ åˆ°dataä¸­
                const replyData = {
                    ...data.data,
                    timestamp: data.timestamp  // ä»äº‹ä»¶é¡¶å±‚è·å–timestamp
                };
                addReplyItem(replyData);
                updateLastUpdate();
            } else if (data.type === 'initial_data') {
                // å¤„ç†åˆå§‹æ•°æ®
                if (data.replies && Array.isArray(data.replies)) {
                    const container = document.getElementById('repliesContainer');
                    if (container.querySelector('.empty-state')) {
                        container.innerHTML = '';
                    }

                    // æŒ‰æ—¶é—´å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                    data.replies.reverse().forEach(reply => {
                        if (reply.type === 'ai_reply' && reply.data) {
                            // å°†timestampæ·»åŠ åˆ°dataä¸­
                            const replyData = {
                                ...reply.data,
                                timestamp: reply.timestamp  // ä»äº‹ä»¶é¡¶å±‚è·å–timestamp
                            };
                            addReplyItem(replyData);
                        }
                    });
                }
            } else if (data.type === 'connected') {
                // è¿æ¥æˆåŠŸï¼Œæ— éœ€å¤„ç†
            } else if (data.type === 'system_event') {
                // ç³»ç»Ÿäº‹ä»¶ï¼Œå¯æ ¹æ®éœ€è¦å¤„ç†
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆå¤„ç†æ—¶åŒºï¼‰
        function formatTime(timestamp) {
            if (!timestamp) return 'æœªçŸ¥æ—¶é—´';

            try {
                let timeStr = String(timestamp).trim();

                // å¤„ç†å„ç§æ—¶é—´æ ¼å¼
                // å¦‚æœåŒ…å«+00:00ï¼Œå·²ç»æ˜¯UTCæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                if (timeStr.includes('+00:00')) {
                    // UTCæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                }
                // å¦‚æœä»¥Zç»“å°¾ï¼Œä¹Ÿæ˜¯UTCæ ¼å¼
                else if (timeStr.endsWith('Z')) {
                    // UTCæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                }
                // å¦‚æœåŒ…å«+0000ï¼ˆæ²¡æœ‰å†’å·ï¼‰ï¼Œä¹Ÿæ˜¯UTCæ ¼å¼
                else if (timeStr.includes('+0000')) {
                    // UTCæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                }
                // å¦‚æœæ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼Œå‡è®¾æ˜¯UTCå¹¶æ·»åŠ Z
                else if (!timeStr.includes('+') && !timeStr.includes('-', 10) && !timeStr.endsWith('Z')) {
                    // æ²¡æœ‰æ—¶åŒºä¿¡æ¯ï¼Œå‡è®¾æ˜¯UTC
                    timeStr = timeStr + 'Z';
                }
                // å¦‚æœæœ‰å…¶ä»–æ—¶åŒºï¼ˆå¦‚+08:00ï¼‰ï¼Œä¿æŒåŸæ ·ï¼ŒJavaScriptä¼šè‡ªåŠ¨å¤„ç†

                // è§£æISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²
                // new Date() ä¼šè‡ªåŠ¨å°†UTCæ—¶é—´è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒº
                const date = new Date(timeStr);

                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) {
                    console.warn('Invalid timestamp:', timestamp, 'processed:', timeStr);
                    return timestamp;
                }

                // éªŒè¯ï¼šç¡®ä¿æ—¥æœŸå¯¹è±¡æ­£ç¡®è§£æäº†UTCæ—¶é—´
                // dateå¯¹è±¡å†…éƒ¨å­˜å‚¨çš„æ˜¯UTCæ—¶é—´ï¼ŒtoLocaleStringä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒº

                // ä½¿ç”¨æœ¬åœ°æ—¶åŒºæ ¼å¼åŒ–ï¼ˆä¸æŒ‡å®štimeZoneï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨ä½¿ç”¨æœ¬åœ°æ—¶åŒºï¼‰
                // toLocaleString ä¼šè‡ªåŠ¨å°†UTCæ—¶é—´è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒº
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                    // ä¸æŒ‡å®š timeZoneï¼Œä½¿ç”¨æµè§ˆå™¨æœ¬åœ°æ—¶åŒº
                };

                // æ ¼å¼åŒ–æœ¬åœ°æ—¶é—´ï¼ˆè‡ªåŠ¨ä»UTCè½¬æ¢ï¼‰
                const localTime = date.toLocaleString('zh-CN', options);

                // è¿”å›æœ¬åœ°æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY/MM/DD HH:mm:ssï¼‰
                return localTime;
            } catch (e) {
                console.error('Time format error:', e, 'timestamp:', timestamp);
                return timestamp;
            }
        }

        // æ·»åŠ å›å¤é¡¹
        function addReplyItem(reply) {
            const container = document.getElementById('repliesContainer');

            // ç§»é™¤ç©ºçŠ¶æ€
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'reply-item';

            const platformClass = `platform-${reply.platform || 'unknown'}`;
            const platformName = reply.platform === 'facebook' ? 'Facebook' :
                reply.platform === 'instagram' ? 'Instagram' : 'Unknown';

            // æ ¼å¼åŒ–æ—¶é—´
            const formattedTime = formatTime(reply.timestamp);

            item.innerHTML = `
                <div class="reply-header">
                    <div>
                        <span class="platform-badge ${platformClass}">${platformName}</span>
                        <strong>${reply.customer_name || `å®¢æˆ· #${reply.customer_id}`}</strong>
                    </div>
                    <div>${formattedTime}</div>
                </div>
                <div class="reply-content">
                    <div class="user-message">
                        <strong>ç”¨æˆ·:</strong> ${reply.user_message || '(æ— æ¶ˆæ¯)'}
                    </div>
                    <div class="ai-reply">
                        <strong>AIå›å¤:</strong> ${reply.ai_reply}
                    </div>
                </div>
            `;

            container.insertBefore(item, container.firstChild);

            // é™åˆ¶æ˜¾ç¤ºæ•°é‡
            const items = container.querySelectorAll('.reply-item');
            if (items.length > 50) {
                items[items.length - 1].remove();
            }
        }

        // åŠ è½½åˆå§‹æ•°æ®
        async function loadInitialData() {
            try {
                const response = await fetch(`${API_BASE}/monitoring/recent-replies?limit=10`);
                const result = await response.json();

                if (result.success && result.data && Array.isArray(result.data)) {
                    const container = document.getElementById('repliesContainer');
                    if (container.querySelector('.empty-state')) {
                        container.innerHTML = '';
                    }

                    // æ•°æ®æ ¼å¼ï¼šresult.data æ˜¯äº‹ä»¶å¯¹è±¡æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡æœ‰ type å’Œ data
                    result.data.reverse().forEach(event => {
                        if (event.type === 'ai_reply' && event.data) {
                            // å°†timestampæ·»åŠ åˆ°dataä¸­
                            const replyData = {
                                ...event.data,
                                timestamp: event.timestamp  // ä»äº‹ä»¶é¡¶å±‚è·å–timestamp
                            };
                            addReplyItem(replyData);
                        }
                    });
                }
            } catch (e) {
                console.error('Failed to load initial data:', e);
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/monitoring/stats`);
                const result = await response.json();

                if (result.success && result.data) {
                    document.getElementById('todayReplies').textContent = result.data.today?.total_replies || 0;
                    document.getElementById('todayCustomers').textContent = result.data.today?.unique_customers || 0;
                    document.getElementById('lastHour').textContent = result.data.last_hour?.replies || 0;
                }
            } catch (e) {
                console.error('Failed to update stats:', e);
            }
        }

        // å¼€å§‹ç»Ÿè®¡æ›´æ–°
        function startStatsUpdate() {
            updateStats();
            statsInterval = setInterval(updateStats, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('lastUpdate').textContent =
                `æœ€åæ›´æ–°: ${timeString} (${Intl.DateTimeFormat().resolvedOptions().timeZone})`;
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
            if (statsInterval) {
                clearInterval(statsInterval);
            }
        });

        // å¯åŠ¨
        init();
    </script>
</body>

</html>