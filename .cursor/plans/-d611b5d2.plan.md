<!-- d611b5d2-dc2d-48e8-bc3d-273415d1eac2 99a57ed7-d1e7-4505-b0be-b76fbc2d0f63 -->
# 生产环境部署前检查与优化方案

## 代码检查结果

### ✅ 已完成的功能

1. **智能垃圾信息检测** - 已实现

- 区分"买卖手机"（垃圾）和"咨询贷款"（有效）
- 优先级判断逻辑正确

2. **自动回复调度器** - 已实现

- 每5分钟扫描未回复消息
- 支持多页面扫描
- 消息同步到数据库

3. **Telegram群链接确保** - 已实现

- 每个客户至少收到一次群链接
- 自动检查历史记录避免重复

### ⚠️ 发现的问题

#### 1. Facebook API端点问题（严重）

**问题**：

- `/conversations` 端点返回400错误
- 可能原因：
- Facebook Graph API v18.0可能不支持此端点
- 需要不同的权限或端点路径
- 端点可能需要使用不同的格式

**影响**：

- API扫描功能无法正常工作
- 只能依赖Webhook接收的消息

**解决方案**：

- 方案A（推荐）：暂时禁用API扫描，只使用Webhook
- 方案B：修复API端点，使用正确的Facebook API端点
- 方案C：使用Facebook Business API替代

#### 2. 缺少API速率限制保护（中等）

**问题**：

- Facebook API调用没有速率限制保护
- 如果页面和对话数量很大，可能触发Facebook速率限制

**影响**：

- 可能被Facebook临时限制API访问
- 系统可能无法正常工作

**解决方案**：

- 在API调用之间添加延迟
- 实现请求队列和批处理
- 添加重试机制和指数退避

#### 3. Telegram群组配置检查（轻微）

**问题**：

- 配置文件中Telegram群组链接已设置：`https://t.me/+bNivsOGSM6ZlMGJl`
- 但需要确认是否所有地方都使用此配置

**解决方案**：

- 验证配置是否正确加载
- 确保所有回复都使用配置中的群组链接

#### 4. 错误处理改进（中等）

**问题**：

- API调用失败时，错误信息不够详细
- 某些错误可能导致整个扫描失败

**解决方案**：

- 改进错误处理，单个失败不影响整体
- 添加更详细的错误日志
- 实现错误重试机制

## 部署前检查清单

### 1. 配置检查

- [ ] **Telegram群组链接**：确认 `config/config.yaml` 中的 `telegram_groups.main_group` 已正确配置
- [ ] **Facebook Token**：确认所有页面Token都是长期Token且未过期
- [ ] **OpenAI API Key**：确认API Key有效且有足够额度
- [ ] **数据库连接**：确认生产环境数据库连接正常
- [ ] **页面设置**：确认所有页面都启用了自动回复

### 2. 功能测试

- [ ] **Webhook接收**：测试接收Facebook消息
- [ ] **自动回复**：测试自动生成和发送回复
- [ ] **垃圾信息检测**：测试"我要买手机"被判定为垃圾，"我想咨询贷款"被正常回复
- [ ] **Telegram群链接**：测试新客户是否自动收到群链接
- [ ] **调度器扫描**：测试5分钟扫描功能（虽然API可能失败，但不应影响整体）

### 3. 性能检查

- [ ] **数据库性能**：检查数据库查询性能
- [ ] **API调用频率**：确认不会超过Facebook API限制
- [ ] **内存使用**：监控内存使用情况
- [ ] **日志大小**：确认日志轮转配置正确

### 4. 安全检查

- [ ] **Token安全**：确认Token存储在安全位置
- [ ] **API密钥**：确认所有API密钥都通过环境变量配置
- [ ] **错误信息**：确认错误日志不包含敏感信息
- [ ] **CORS配置**：确认生产环境CORS配置正确

## 部署方案

### 方案A：保守部署（推荐）

**策略**：先禁用API扫描功能，只使用Webhook

**步骤**：

1. 修改 `auto_reply_scheduler.py`，暂时禁用API扫描
2. 保留Webhook消息处理功能
3. 部署到生产环境
4. 监控运行情况
5. 逐步启用API扫描功能

**优点**：

- 风险最低
- Webhook功能已验证可用
- 可以逐步测试

**缺点**：

- 无法扫描遗漏的消息
- 依赖Webhook的可靠性

### 方案B：完整部署

**策略**：修复API端点问题后完整部署

**步骤**：

1. 修复Facebook API端点问题
2. 添加API速率限制保护
3. 改进错误处理
4. 完整测试
5. 部署到生产环境

**优点**：

- 功能完整
- 可以扫描遗漏的消息

**缺点**：

- 需要更多时间修复问题
- 风险较高

### 方案C：分阶段部署

**策略**：分阶段启用功能

**阶段1**：基础功能（立即部署）

- Webhook消息接收
- 自动回复生成
- 垃圾信息检测
- Telegram群链接确保

**阶段2**：API扫描（1-2周后）

- 修复API端点问题
- 添加速率限制
- 启用API扫描

## 推荐方案

**推荐使用方案A（保守部署）**

**理由**：

1. Webhook功能已验证可用，风险低
2. 核心功能（自动回复、垃圾检测、群链接）都已实现
3. API扫描功能虽然有用，但不是核心功能
4. 可以后续逐步完善

## 部署前必须修复的问题

### 1. 改进API错误处理（必须）

在 `src/facebook/api_client.py` 的 `check_unreplied_messages` 方法中：

- 添加更详细的错误处理
- 400错误时不要抛出异常，而是记录日志并返回空列表
- 确保单个页面失败不影响其他页面

### 2. 添加API调用延迟（建议）

在 `src/auto_reply/auto_reply_scheduler.py` 中：

- 在处理每个对话之间添加小延迟（如0.5秒）
- 避免触发Facebook速率限制

### 3. 改进Telegram群链接检测（建议）

在 `src/ai/reply_generator.py` 中：

- 改进 `_has_received_telegram_link` 方法，更准确地检测群链接
- 支持检测配置中的实际群组链接格式

## 部署步骤

### 步骤1：代码优化（1-2小时）

1. 改进API错误处理
2. 添加API调用延迟
3. 改进Telegram群链接检测
4. 添加更多日志

### 步骤2：配置验证（30分钟）

1. 检查所有配置文件
2. 验证Token有效性
3. 测试数据库连接
4. 验证Telegram群组链接

### 步骤3：功能测试（1小时）

1. 测试Webhook接收
2. 测试自动回复
3. 测试垃圾信息检测
4. 测试Telegram群链接

### 步骤4：部署（30分钟）

1. 备份当前版本
2. 部署新代码
3. 重启服务
4. 验证服务运行

### 步骤5：监控（持续）

1. 监控日志
2. 监控错误率
3. 监控回复成功率
4. 监控系统资源

## 风险评估

### 高风险项

1. **Facebook API端点问题** - 可能导致API扫描失败

- 缓解措施：暂时禁用API扫描，只使用Webhook

2. **Token过期** - 可能导致无法发送消息

- 缓解措施：使用长期Token，添加过期预警

### 中风险项

1. **API速率限制** - 可能被Facebook限制

- 缓解措施：添加调用延迟和重试机制

2. **数据库性能** - 大量消息可能导致性能问题

- 缓解措施：添加数据库索引，优化查询

### 低风险项

1. **Telegram群链接检测** - 可能误判

- 缓解措施：改进检测逻辑

## 监控指标

部署后需要监控以下指标：

1. **回复成功率**：成功回复数 / 总消息数
2. **错误率**：错误数 / 总处理数
3. **平均回复时间**：从收到消息到发送回复的时间
4. **API调用成功率**：API调用成功数 / 总调用数
5. **系统资源使用**：CPU、内存、磁盘使用率

## 回滚方案

如果部署后出现问题：

1. **立即回滚**：恢复到上一个稳定版本
2. **禁用功能**：在配置中禁用自动回复
3. **修复问题**：在测试环境修复后重新部署

## 总结

**当前状态**：

- ✅ 核心功能已实现
- ⚠️ API扫描功能有问题但可以暂时禁用
- ✅ 代码质量良好，无严重错误

**建议**：

- 使用方案A（保守部署）
- 先部署核心功能
- 后续逐步完善API扫描功能

**预计部署时间**：2-3小时（包括测试）

### To-dos

- [ ] 在FacebookAPIClient中添加获取对话和消息的方法（get_conversations, get_conversation_messages, check_unreplied_messages）
- [ ] 修改ReplyGenerator._is_spam_or_invalid方法，放宽垃圾信息判断标准
- [ ] 重构AutoReplyScheduler，添加从API扫描所有启用页面的功能
- [ ] 添加消息同步到数据库的功能，确保API获取的消息都有记录
- [ ] 改进日志记录，添加详细的扫描统计信息